{% extends "base.html" %}

{% block title %}Painel Administrativo - Family Guardian 360°{% endblock %}

{% block body %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-user-shield"></i> Painel de Super Administrador</h1>
        <p>Controle Total: Gerencie e monitore todos os usuários do sistema</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('map')">
            <i class="fas fa-globe"></i> Mapa Global
        </button>
        <button class="tab-btn" onclick="switchTab('users')">
            <i class="fas fa-users-cog"></i> Todos os Usuários
        </button>
        <button class="tab-btn" onclick="switchTab('admins')">
            <i class="fas fa-crown"></i> Admins de Família
        </button>
        <button class="tab-btn" onclick="switchTab('cloud')">
            <i class="fas fa-cloud"></i> Sincronização Cloud
        </button>
    </div>

    <div id="mapTab" class="tab-content active">
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"><i class="fas fa-globe"></i> Mapa Global de Usuários</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm" onclick="refreshAllLocations()" style="background: #007bff; color: white;">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <button class="btn btn-sm" onclick="showAllUsers()" style="background: #28a745; color: white;">
                        <i class="fas fa-expand"></i> Ver Todos
                    </button>
                </div>
            </div>

            <div class="map-stats">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div>
                        <h3 id="totalUsersCount">0</h3>
                        <p>Total de Usuários</p>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <h3 id="usersWithLocationCount">0</h3>
                        <p>Com Localização</p>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-check"></i>
                    <div>
                        <h3 id="activeUsersCount">0</h3>
                        <p>Ativos (15 min)</p>
                    </div>
                </div>
            </div>

            <div class="map-layout">
                <div class="user-list-sidebar">
                    <h3><i class="fas fa-list"></i> Usuários</h3>
                    <input type="text" id="userSearchInput" placeholder="Buscar usuário..." class="search-input">
                    <div id="adminUsersList" class="admin-users-list"></div>
                </div>
                <div class="map-main">
                    <div id="adminGlobalMap" style="width: 100%; height: 600px; border-radius: 8px;"></div>
                    <div id="selected-user-panel" class="selected-user-panel" style="display: none;">
                        <div class="panel-header">
                            <h4 id="selected-user-name">Detalhes do Usuário</h4>
                            <button class="btn-icon" onclick="hideSelectedUserDetails()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="panel-body" id="selected-user-details">
                            <!-- User details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="usersTab" class="tab-content">
        <div class="admin-section">
            <h2><i class="fas fa-users-cog"></i> Todos os Usuários</h2>
            <div id="usersList" class="users-grid"></div>
        </div>
    </div>

    <div id="adminsTab" class="tab-content">
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"><i class="fas fa-crown"></i> Administradores de Família</h2>
                <button class="btn" onclick="showCreateFamilyAdminModal()" style="background: #28a745; color: white;">
                    <i class="fas fa-user-plus"></i> Criar Novo Admin de Família
                </button>
            </div>
            <div id="familyAdminsList" class="users-grid"></div>
        </div>
    </div>

    <div id="cloudTab" class="tab-content">
        <div class="admin-section">
                <h3><i class="fas fa-database"></i> Status dos Bancos de Dados</h3>
                <div id="databaseStatus" class="database-status">
                    <p>Carregando status...</p>
                </div>
                <button onclick="checkDatabaseStatus()" class="btn btn-info" style="margin-top: 10px;">
                    <i class="fas fa-sync"></i> Atualizar Status
                </button>
            </div>

            <div class="admin-section">
                <h3><i class="fas fa-cloud"></i> Sincronização com Cloud</h3>
                <div id="cloudStatus" class="cloud-status">
                    <p>Carregando status...</p>
                </div>
                <div class="btn-group">
                    <button onclick="pullFromCloud()" class="btn btn-primary">
                        <i class="fas fa-cloud-download-alt"></i> Puxar do Cloud
                    </button>
                    <button onclick="pushToCloud()" class="btn btn-success">
                        <i class="fas fa-cloud-upload-alt"></i> Enviar para Cloud
                    </button>
                </div>
            </div>

            <div class="cloud-info">
                <h3><i class="fas fa-question-circle"></i> Como Configurar</h3>
                <ol>
                    <li>Crie uma conta em <a href="https://sqlitecloud.io" target="_blank">SQLite Cloud</a></li>
                    <li>Crie um novo banco de dados na plataforma</li>
                    <li>Copie a string de conexão (formato: <code>sqlitecloud://user:pass@host.sqlite.cloud:8860/dbname</code>)</li>
                    <li>Adicione a variável de ambiente <code>SQLITE_CLOUD_URL</code> no Replit com sua string de conexão</li>
                    <li>Reinicie o aplicativo</li>
                </ol>
                <p><strong>Funcionamento Automático:</strong></p>
                <ul>
                    <li>✅ Todas as escritas (INSERT/UPDATE/DELETE) são sincronizadas automaticamente para o Cloud</li>
                    <li>✅ Em novos deploys, os dados são puxados automaticamente do Cloud</li>
                    <li>✅ Você pode forçar sincronização manual usando os botões acima</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="createFamilyAdminModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeCreateFamilyAdminModal()">&times;</span>
        <h2><i class="fas fa-user-plus"></i> Criar Novo Admin de Família</h2>
        <p>Crie um novo usuário com privilégios de Admin de Família e sua família inicial</p>

        <form id="createFamilyAdminForm" onsubmit="createFamilyAdmin(event)">
            <h3 style="margin-top: 30px; color: #007bff;">Dados do Usuário</h3>
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" name="full_name" required class="form-control">
            </div>

            <div class="form-group">
                <label>CPF</label>
                <input type="text" name="cpf" required class="form-control" maxlength="14">
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required class="form-control">
            </div>

            <div class="form-group">
                <label>Senha</label>
                <input type="password" name="password" required class="form-control" minlength="6">
            </div>

            <div class="form-group">
                <label>Data de Nascimento</label>
                <input type="date" name="birth_date" required class="form-control">
            </div>

            <h3 style="margin-top: 30px; color: #007bff;">Dados da Família</h3>
            <div class="form-group">
                <label>Nome da Família</label>
                <input type="text" name="family_name" required class="form-control">
            </div>

            <div class="form-group">
                <label>Descrição (opcional)</label>
                <textarea name="family_description" class="form-control" rows="3"></textarea>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                <button type="submit" class="btn" style="background: #28a745; color: white;">
                    <i class="fas fa-check"></i> Criar Admin de Família
                </button>
                <button type="button" class="btn" onclick="closeCreateFamilyAdminModal()" style="background: #6c757d; color: white;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 12px 24px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
}

.tab-btn:hover {
    background: #f3f4f6;
}

.tab-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.admin-section {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.map-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-card i {
    font-size: 36px;
    opacity: 0.9;
}

.stat-card h3 {
    margin: 0;
    font-size: 32px;
    font-weight: bold;
}

.stat-card p {
    margin: 0;
    font-size: 13px;
    opacity: 0.9;
}

.map-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    margin-top: 20px;
}

.user-list-sidebar {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    max-height: 600px;
    overflow-y: auto;
}

.user-list-sidebar h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
}

.search-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 15px;
}

.admin-users-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.admin-user-item {
    background: white;
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 3px solid transparent;
}

.admin-user-item:hover {
    background: #e3f2fd;
    border-left-color: #007bff;
}

.admin-user-item.selected {
    background: #e3f2fd;
    border-left-color: #007bff;
}

.admin-user-item.no-location {
    opacity: 0.6;
}

.admin-user-name {
    font-weight: 600;
    margin: 0 0 5px 0;
    font-size: 14px;
}

.admin-user-info {
    font-size: 12px;
    color: #666;
    margin: 2px 0;
}

.admin-user-status {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    margin-top: 5px;
}

.status-online {
    background: #d4edda;
    color: #155724;
}

.admin-user-status.status-offline {
    background: #f8d7da;
    color: #721c24;
}

.selected-user-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 320px;
    max-height: 560px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    z-index: 1000;
    overflow: hidden;
}

.panel-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h4 {
    margin: 0;
    font-size: 16px;
}

.panel-header .btn-icon {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.panel-header .btn-icon:hover {
    background: rgba(255,255,255,0.3);
}

.panel-body {
    padding: 15px;
    max-height: 480px;
    overflow-y: auto;
}

.panel-body h5 {
    font-size: 14px;
    font-weight: 600;
}

.panel-body p {
    font-size: 13px;
    color: #333;
}

.map-main {
    position: relative;
}

@media (max-width: 768px) {
    .map-layout {
        grid-template-columns: 1fr;
    }

    .user-list-sidebar {
        max-height: 300px;
    }
}

.users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.user-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.user-card.super-admin {
    border-left-color: #dc3545;
}

.user-card.family-admin {
    border-left-color: #ffc107;
}

.user-card h3 {
    margin: 0 0 10px 0;
    font-size: 1.1em;
}

.user-card .user-info {
    font-size: 0.9em;
    color: #666;
    margin: 5px 0;
}

.user-card .user-type {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
    margin-top: 10px;
}

.user-type.super-admin {
    background: #dc3545;
    color: white;
}

.user-type.family-admin {
    background: #ffc107;
    color: #333;
}

.user-type.member {
    background: #6c757d;
    color: white;
}

.user-actions {
    margin-top: 15px;
}

.btn-sm {
    padding: 5px 15px;
    font-size: 0.85em;
    margin-right: 5px;
}

.btn-promote {
    background: #ffc107;
    color: #333;
}

.btn-demote {
    background: #6c757d;
    color: white;
}

.cloud-status-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.cloud-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.cloud-info {
    background: #e7f3ff;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.cloud-info h3 {
    margin-top: 0;
}

.cloud-info code {
    background: #fff;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
}
</style>

<script>
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();

        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';

        data.users.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = `user-card ${user.user_type}`;

            let typeLabel = 'Membro';
            if (user.user_type === 'super_admin') typeLabel = 'Super Admin';
            else if (user.user_type === 'family_admin') typeLabel = 'Admin de Família';

            let actions = '';
            if (user.user_type !== 'super_admin') {
                if (user.user_type === 'member') {
                    actions = `<button class="btn btn-sm btn-promote" onclick="promoteUser(${user.id}, '${user.full_name}')">
                        <i class="fas fa-arrow-up"></i> Promover para Admin de Família
                    </button>`;
                } else if (user.user_type === 'family_admin') {
                    actions = `<button class="btn btn-sm btn-demote" onclick="demoteUser(${user.id}, '${user.full_name}')">
                        <i class="fas fa-arrow-down"></i> Rebaixar para Membro
                    </button>`;
                }
            }

            userCard.innerHTML = `
                <h3>${user.full_name}</h3>
                <div class="user-info"><i class="fas fa-user"></i> ${user.username}</div>
                <div class="user-info"><i class="fas fa-envelope"></i> ${user.email}</div>
                <div class="user-info"><i class="fas fa-calendar"></i> Criado: ${new Date(user.created_at).toLocaleDateString('pt-BR')}</div>
                <span class="user-type ${user.user_type}">${typeLabel}</span>
                <div class="user-actions">${actions}</div>
            `;

            usersList.appendChild(userCard);
        });
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        alert('Erro ao carregar usuários');
    }
}

async function loadFamilyAdmins() {
    try {
        const response = await fetch('/api/admin/family-admins');
        const data = await response.json();

        const adminsList = document.getElementById('familyAdminsList');
        adminsList.innerHTML = '';

        if (data.family_admins.length === 0) {
            adminsList.innerHTML = '<p style="color: #666;">Nenhum Admin de Família cadastrado ainda.</p>';
            return;
        }

        data.family_admins.forEach(admin => {
            const adminCard = document.createElement('div');
            adminCard.className = 'user-card family-admin';

            adminCard.innerHTML = `
                <h3>${admin.full_name}</h3>
                <div class="user-info"><i class="fas fa-user"></i> ${admin.username}</div>
                <div class="user-info"><i class="fas fa-envelope"></i> ${admin.email}</div>
                <div class="user-info"><i class="fas fa-calendar"></i> Desde: ${new Date(admin.created_at).toLocaleDateString('pt-BR')}</div>
                <span class="user-type family-admin">Admin de Família</span>
                <div class="user-actions">
                    <button class="btn btn-sm btn-demote" onclick="demoteUser(${admin.id}, '${admin.full_name}')">
                        <i class="fas fa-arrow-down"></i> Rebaixar para Membro
                    </button>
                </div>
            `;

            adminsList.appendChild(adminCard);
        });
    } catch (error) {
        console.error('Erro ao carregar admins:', error);
    }
}

async function promoteUser(userId, fullName) {
    if (!confirm(`Promover ${fullName} para Admin de Família?`)) {
        return;
    }

    try {
        const response = await fetch('/api/admin/promote-family-admin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            loadUsers();
            loadFamilyAdmins();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Erro ao promover usuário');
    }
}

async function demoteUser(userId, fullName) {
    if (!confirm(`Rebaixar ${fullName} para Membro regular?`)) {
        return;
    }

    try {
        const response = await fetch('/api/admin/demote-user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            loadUsers();
            loadFamilyAdmins();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Erro ao rebaixar usuário');
    }
}

function showCreateFamilyAdminModal() {
    document.getElementById('createFamilyAdminModal').style.display = 'block';
}

function closeCreateFamilyAdminModal() {
    document.getElementById('createFamilyAdminModal').style.display = 'none';
    document.getElementById('createFamilyAdminForm').reset();
}

async function createFamilyAdmin(event) {
    event.preventDefault();

    const form = event.target;
    const formData = {
        full_name: form.full_name.value,
        cpf: form.cpf.value,
        email: form.email.value,
        password: form.password.value,
        birth_date: form.birth_date.value,
        family_name: form.family_name.value,
        family_description: form.family_description.value
    };

    try {
        const response = await fetch('/api/admin/create-family-admin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            closeCreateFamilyAdminModal();
            loadUsers();
            loadFamilyAdmins();
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('Erro ao criar Family Admin:', error);
        alert('Erro ao criar Admin de Família');
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('createFamilyAdminModal');
    if (event.target == modal) {
        closeCreateFamilyAdminModal();
    }
}

let adminMap = null;
let adminMarkers = {};
let allUsersData = [];
let selectedUserId = null;

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');

    if (tabName === 'map' && !adminMap) {
        setTimeout(() => initAdminMap(), 100);
    }
}

function initAdminMap() {
    if (adminMap) return;

    adminMap = L.map('adminGlobalMap').setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(adminMap);

    setTimeout(() => adminMap.invalidateSize(), 100);
    refreshAllLocations();
}

async function refreshAllLocations() {
    try {
        const response = await fetch('/api/admin/all-locations');
        const data = await response.json();

        if (!data.success) {
            console.error('Erro ao carregar localizações');
            return;
        }

        allUsersData = data.locations;

        document.getElementById('totalUsersCount').textContent = data.total_users;
        document.getElementById('usersWithLocationCount').textContent = data.users_with_location;

        const activeUsers = allUsersData.filter(u => {
            if (!u.user.last_seen) return false;
            const lastSeen = new Date(u.user.last_seen);
            const now = new Date();
            return (now - lastSeen) < 15 * 60 * 1000;
        }).length;
        document.getElementById('activeUsersCount').textContent = activeUsers;

        updateUsersList();
        updateMapMarkers();

    } catch (error) {
        console.error('Erro ao atualizar localizações:', error);
    }
}

function updateUsersList() {
    const container = document.getElementById('adminUsersList');
    const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();

    const filteredUsers = allUsersData.filter(u => 
        u.user.full_name.toLowerCase().includes(searchTerm) ||
        u.user.email.toLowerCase().includes(searchTerm)
    );

    container.innerHTML = filteredUsers.map(userData => {
        const user = userData.user;
        const location = userData.location;
        const hasLocation = location !== null;

        const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
        const isActive = lastSeen && (new Date() - lastSeen) < 15 * 60 * 1000;

        const userTypeLabel = user.user_type === 'family_admin' ? 'Admin' : 
                             user.user_category ? user.user_category : 'Membro';

        return `
            <div class="admin-user-item ${!hasLocation ? 'no-location' : ''} ${selectedUserId === user.id ? 'selected' : ''}" 
                 onclick="focusOnUserInMap(${user.id})">
                <p class="admin-user-name">
                    ${user.full_name}
                    ${hasLocation ? '<i class="fas fa-map-marker-alt" style="color: #28a745; margin-left: 5px;"></i>' : ''}
                </p>
                <p class="admin-user-info">
                    <i class="fas fa-envelope"></i> ${user.email}
                </p>
                <p class="admin-user-info">
                    <i class="fas fa-tag"></i> ${userTypeLabel}
                </p>
                ${userData.families.length > 0 ? `
                    <p class="admin-user-info">
                        <i class="fas fa-users"></i> ${userData.families.map(f => f.name).join(', ')}
                    </p>
                ` : ''}
                <span class="admin-user-status ${isActive ? 'status-online' : 'status-offline'}">
                    ${isActive ? 'Online' : 'Offline'}
                </span>
            </div>
        `;
    }).join('');
}

function updateMapMarkers() {
    if (!adminMap) return;

    Object.values(adminMarkers).forEach(marker => adminMap.removeLayer(marker));
    adminMarkers = {};

    const validLocations = allUsersData.filter(u => u.location);

    validLocations.forEach(userData => {
        const user = userData.user;
        const location = userData.location;

        const lat = location.latitude;
        const lon = location.longitude;

        let markerColor = '#007bff';
        if (user.user_type === 'family_admin') markerColor = '#ffc107';
        if (location.battery_level < 20) markerColor = '#dc3545';

        const icon = L.divIcon({
            html: `<div style="background: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user" style="color: white; font-size: 14px;"></i>
            </div>`,
            className: 'custom-admin-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const marker = L.marker([lat, lon], { icon }).addTo(adminMap);

        const batteryIcon = location.battery_level > 75 ? 'fa-battery-full' : 
                           location.battery_level > 50 ? 'fa-battery-three-quarters' :
                           location.battery_level > 25 ? 'fa-battery-half' : 'fa-battery-quarter';

        const popupContent = `
            <div style="min-width: 200px;">
                <h4 style="margin: 0 0 10px 0;">${user.full_name}</h4>
                <p style="margin: 5px 0; font-size: 13px;">
                    <i class="fas fa-envelope"></i> ${user.email}
                </p>
                <p style="margin: 5px 0; font-size: 13px;">
                    <i class="fas fa-map-marker-alt"></i> ${lat.toFixed(5)}, ${lon.toFixed(5)}
                </p>
                ${location.battery_level ? `
                    <p style="margin: 5px 0; font-size: 13px;">
                        <i class="fas ${batteryIcon}"></i> Bateria: ${location.battery_level}%
                    </p>
                ` : ''}
                <p style="margin: 5px 0; font-size: 12px; color: #666;">
                    <i class="fas fa-clock"></i> ${new Date(location.timestamp).toLocaleString('pt-BR')}
                </p>
                <button onclick="showUserDetails(${user.id})" class="btn btn-sm" 
                        style="margin-top: 10px; width: 100%; background: #007bff; color: white;">
                    <i class="fas fa-info-circle"></i> Ver Detalhes
                </button>
            </div>
        `;

        marker.bindPopup(popupContent);
        adminMarkers[user.id] = marker;
    });

    if (validLocations.length > 0) {
        const group = L.featureGroup(Object.values(adminMarkers));
        adminMap.fitBounds(group.getBounds().pad(0.1));
    }
}

function focusOnUserInMap(userId) {
    selectedUserId = userId;
    updateUsersList();

    if (adminMarkers[userId]) {
        const marker = adminMarkers[userId];
        adminMap.setView(marker.getLatLng(), 16);
        marker.openPopup();
        showSelectedUserDetails(userId);
    }
}

function showAllUsers() {
    selectedUserId = null;
    updateUsersList();
    hideSelectedUserDetails();

    if (Object.keys(adminMarkers).length > 0) {
        const group = L.featureGroup(Object.values(adminMarkers));
        adminMap.fitBounds(group.getBounds().pad(0.1));
    }
}

async function showUserDetails(userId) {
    try {
        const response = await fetch(`/api/admin/user/${userId}/details`);
        const data = await response.json();

        if (!data.success) {
            alert('Erro ao carregar detalhes do usuário');
            return;
        }

        const user = data.user;
        const location = data.location;

        let detailsHTML = `
            <div style="max-width: 600px;">
                <h2><i class="fas fa-user"></i> ${user.full_name}</h2>
                <div style="margin: 20px 0;">
                    <h3>Informações Pessoais</h3>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Username:</strong> ${user.username}</p>
                    <p><strong>CPF:</strong> ${user.cpf || 'N/A'}</p>
                    <p><strong>Tipo:</strong> ${user.user_type}</p>
                    ${user.user_category ? `<p><strong>Categoria:</strong> ${user.user_category}</p>` : ''}
                </div>
        `;

        if (location) {
            detailsHTML += `
                <div style="margin: 20px 0;">
                    <h3>Última Localização</h3>
                    <p><strong>Coordenadas:</strong> ${location.latitude}, ${location.longitude}</p>
                    <p><strong>Bateria:</strong> ${location.battery_level}%</p>
                    <p><strong>Timestamp:</strong> ${new Date(location.timestamp).toLocaleString('pt-BR')}</p>
                </div>
            `;
        }

        if (data.families.length > 0) {
            detailsHTML += `
                <div style="margin: 20px 0;">
                    <h3>Famílias</h3>
                    ${data.families.map(f => `<p>• ${f.name} (${f.role})</p>`).join('')}
                </div>
            `;
        }

        if (data.alerts.length > 0) {
            detailsHTML += `
                <div style="margin: 20px 0;">
                    <h3>Alertas Recentes</h3>
                    ${data.alerts.slice(0, 5).map(a => `
                        <p style="font-size: 13px;">
                            • ${a.alert_message} 
                            <small>(${new Date(a.created_at).toLocaleString('pt-BR')})</small>
                        </p>
                    `).join('')}
                </div>
            `;
        }

        detailsHTML += '</div>';

        const detailsWindow = window.open('', '_blank', 'width=700,height=600');
        detailsWindow.document.write(`
            <html>
                <head>
                    <title>Detalhes - ${user.full_name}</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h2 { color: #007bff; }
                        h3 { color: #333; margin-top: 20px; }
                    </style>
                </head>
                <body>${detailsHTML}</body>
            </html>
        `);

    } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar detalhes do usuário');
    }
}

function showSelectedUserDetails(userId) {
    const panel = document.getElementById('selected-user-panel');
    const detailsContainer = document.getElementById('selected-user-details');
    const userNameHeader = document.getElementById('selected-user-name');

    fetch(`/api/admin/user/${userId}/details`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error("Failed to load user details");
                return;
            }
            const user = data.user;
            const location = data.location;

            let detailsHTML = `
                <h5>Informações Pessoais</h5>
                <p><strong>Nome:</strong> ${user.full_name}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Tipo:</strong> ${user.user_type === 'super_admin' ? 'Super Admin' : user.user_type === 'family_admin' ? 'Admin de Família' : 'Membro'}</p>
            `;

            if (location) {
                detailsHTML += `
                    <h5 style="margin-top: 15px;">Localização</h5>
                    <p><strong>Coordenadas:</strong> ${location.latitude.toFixed(5)}, ${location.longitude.toFixed(5)}</p>
                    <p><strong>Bateria:</strong> ${location.battery_level}%</p>
                    <p><strong>Atualizado:</strong> ${new Date(location.timestamp).toLocaleString('pt-BR')}</p>
                `;
            }

            if (data.families.length > 0) {
                detailsHTML += `
                    <h5 style="margin-top: 15px;">Famílias</h5>
                    ${data.families.map(f => `<p>• ${f.name}</p>`).join('')}
                `;
            }

            detailsContainer.innerHTML = detailsHTML;
            userNameHeader.textContent = user.full_name;
            panel.style.display = 'block';
        })
        .catch(error => {
            console.error("Error fetching user details:", error);
        });
}

function hideSelectedUserDetails() {
    document.getElementById('selected-user-panel').style.display = 'none';
    selectedUserId = null;
    updateUsersList();
}


document.getElementById('userSearchInput')?.addEventListener('input', updateUsersList);

setInterval(refreshAllLocations, 10000);

loadUsers();
loadFamilyAdmins();
checkDatabaseStatus();
loadCloudStatus();
setTimeout(() => initAdminMap(), 500);

async function checkDatabaseStatus() {
        const statusDiv = document.getElementById('databaseStatus');
        statusDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Verificando bancos de dados...</p>';

        try {
            const response = await fetch('/api/admin/database-status');
            const data = await response.json();

            if (data.success) {
                const local = data.local;
                const cloud = data.cloud;
                const inSync = data.in_sync;

                statusDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">
                                <i class="fas fa-database"></i> Banco Local
                            </h4>
                            <p><strong>Status:</strong> ${local.exists ? '✅ Ativo' : '❌ Não encontrado'}</p>
                            <p><strong>Tamanho:</strong> ${local.size_mb} MB</p>
                            <p><strong>Usuários:</strong> ${local.users_count}</p>
                            <p><strong>Famílias:</strong> ${local.families_count}</p>
                            <p><strong>Localizações:</strong> ${local.locations_count}</p>
                            ${local.error ? `<p style="color: #e74c3c;"><strong>Erro:</strong> ${local.error}</p>` : ''}
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">
                                <i class="fas fa-cloud"></i> Banco Cloud
                            </h4>
                            <p><strong>Status:</strong> ${cloud.enabled ? (cloud.connected ? '✅ Conectado' : '⚠️ Desconectado') : '❌ Desabilitado'}</p>
                            ${cloud.enabled ? `
                                <p><strong>Usuários:</strong> ${cloud.users_count}</p>
                                <p><strong>Famílias:</strong> ${cloud.families_count}</p>
                                <p><strong>Localizações:</strong> ${cloud.locations_count}</p>
                                ${cloud.error ? `<p style="color: #e74c3c;"><strong>Erro:</strong> ${cloud.error}</p>` : ''}
                            ` : '<p>Cloud não configurado</p>'}
                        </div>
                    </div>

                    ${cloud.enabled ? `
                        <div style="margin-top: 15px; padding: 10px; background: ${inSync ? '#d4edda' : '#fff3cd'}; border-radius: 5px;">
                            <strong>${inSync ? '✅ Bancos sincronizados' : '⚠️ Bancos com dados diferentes'}</strong>
                        </div>
                    ` : ''}
                `;
            } else {
                statusDiv.innerHTML = '<p style="color: #e74c3c;">❌ Erro ao verificar status dos bancos</p>';
            }
        } catch (error) {
            console.error('Erro ao verificar status:', error);
            statusDiv.innerHTML = '<p style="color: #e74c3c;">❌ Erro ao carregar status dos bancos</p>';
        }
    }

async function loadCloudStatus() {
        const statusDiv = document.getElementById('cloudStatus');

        try {
            const response = await fetch('/api/admin/cloud-sync/status');
            const data = await response.json();

            if (data.cloud_enabled) {
                statusDiv.innerHTML = `
                    <div style="color: #28a745;">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Cloud conectado e sincronizando automaticamente</strong>
                    </div>
                    <p style="margin-top: 10px; color: #666;">
                        Todas as alterações são salvas tanto localmente quanto no SQLite Cloud.
                    </p>
                `;
            } else if (data.cloud_configured) {
                statusDiv.innerHTML = `
                    <div style="color: #ffc107;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Cloud configurado mas offline</strong>
                    </div>
                    <p style="margin-top: 10px; color: #666;">
                        Verifique sua conexão e string de conexão.
                    </p>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="color: #dc3545;">
                        <i class="fas fa-times-circle"></i> 
                        <strong>Cloud não configurado</strong>
                    </div>
                    <p style="margin-top: 10px; color: #666;">
                        Configure a variável de ambiente SQLITE_CLOUD_URL para habilitar sincronização.
                    </p>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar status do Cloud:', error);
        }
    }

async function pullFromCloud() {
    if (!confirm('Isso vai substituir todos os dados locais pelos dados do Cloud. Continuar?')) {
        return;
    }

    try {
        const response = await fetch('/api/admin/cloud-sync/pull', {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            alert('✅ Dados sincronizados do Cloud com sucesso!');
            location.reload();
        } else {
            alert('❌ ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao puxar do Cloud:', error);
        alert('❌ Erro ao sincronizar do Cloud');
    }
}

async function pushToCloud() {
    if (!confirm('Isso vai enviar todos os dados locais para o Cloud. Continuar?')) {
        return;
    }

    try {
        const response = await fetch('/api/admin/cloud-sync/push', {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            alert('✅ Dados enviados para o Cloud com sucesso!');
        } else {
            alert('❌ ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao enviar para Cloud:', error);
        alert('❌ Erro ao enviar para o Cloud');
    }
}

// Carrega status do Cloud quando a aba é aberta
const originalSwitchTab = switchTab;
switchTab = function(tabName) {
    originalSwitchTab.call(this, tabName);
    if (tabName === 'cloud') {
        loadCloudStatus();
    }
}
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% endblock %}